<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minhas Transações</title>
  <link rel="stylesheet" href="{{ url_for('transactions.static', filename='css/transaction_form_page.css') }}">
  <script src="{{ url_for('transactions.static', filename='js/transaction_form_page.js') }}"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>

<body>
  <div class="form-content">
    <form action="{% if transaction %}
        {{ url_for('transactions.transaction_edit_page', transaction_id=transaction.transaction_id) }}
      {% else %}
        {{ url_for('transactions.transaction_create_page') }}
      {% endif %}" method="POST">

      <h1>{% if transaction %}Sua Transação{% else %}Nova Transação{% endif %}</h1>

      <div class="first-input-row">
        <div class="title-container">
          <label for="title">Título</label>
          <input type="text" id="title" name="title" placeholder="Digite um Título" required
            value="{{ transaction.title if transaction else '' }}" />
        </div>

        <div class="payment-method-container">
          <label for="payment_method">Método de Pagamento</label>
          <select id="payment_method" name="payment_method" required>
            <option value="" disabled {% if not transaction %}selected{% endif %}>Selecione uma opção</option>
            {% for option in ['Debito', 'Credito', 'PIX', 'Boleto', 'Outro'] %}
              <option value="{{ option }}"
                {% if transaction and transaction.payment_method == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="second-input-row">
        <div class="amount-container">
          <label for="amount">Valor</label>
          <input type="text" id="amount" name="amount" placeholder="Digite um Valor"
            value="{{ transaction.amount if transaction else '' }}" required />
        </div>

        <div class="date-container">
          <label for="transaction_date">Data</label>
          <input type="date" id="transaction_date" name="transaction_date"
            value="{{ transaction.transaction_date if transaction else '' }}" required />
        </div>

        <div class="category-container">
          <label for="category">Categoria</label>
          <div style="display: flex; gap: 10px;">
            <select id="category" name="category" required>
              <option value="" disabled selected>Selecione uma opção</option>
              {% for category in categories %}
              <option value="{{ category.name }}"
                {% if transaction and transaction.category == category.name %}selected{% endif %}>
                {{ category.name }}
              </option>
              {% endfor %}
            </select>
            <button type="button" onclick="openCategoryModal()">+</button>
          </div>
        </div>
      </div>

      <div class="input-container">
        <label for="description">Descrição</label>
        <textarea id="description" name="description"
          placeholder="Digite uma Descrição para a sua Transação">{{ transaction.description if transaction else '' }}</textarea>
      </div>

      <div class="is_recurring_content">
        <div class="left-content">
          <input type="checkbox" id="checkbox" name="is_recurring"
            {% if transaction and transaction.is_recurring %}checked{% endif %}
            onchange="toggleNumberOfPayments()">
          <p class="checkbox_label">Transação Recorrente</p>
        </div>

        <div style="display: none;" id="number-of-payments-container">
          <label for="number_of_payments">Número de parcelas</label>
          <input type="number" id="number_of_payments" name="number_of_payments" placeholder="Número de parcelas"
            value="{% if transaction and transaction.number_of_payments %}{{ transaction.number_of_payments }}{% else %}2{% endif %}">
        </div>
      </div>

      <div class="transaction-type-buttons">
        <button type="button" id="income-btn" class="income-btn"
          onclick="setTransactionType('income'); changeButtonColor(this)">
          <i class="bi bi-caret-up-square-fill"></i> Receita
        </button>
        <button type="button" id="expense-btn" class="expense-btn"
          onclick="setTransactionType('expense'); changeButtonColor(this)">
          <i class="bi bi-caret-down-square-fill"></i> Despesa
        </button>
      </div>
      <input type="hidden" id="transaction_type" name="transaction_type"
        value="{{ transaction.transaction_type if transaction else '' }}">

      <div class="options-container" {% if not transaction %}style="justify-content: right;"{% endif %}>
        {% if transaction %}
        <button type="submit" class="delete-btn">
          <a href="{{ url_for('transactions.transaction_delete', transaction_id=transaction.transaction_id) }}">Deletar</a>
        </button>
        {% endif %}

        <div class="right-buttons">
          <a class="cancel-btn" onclick="window.history.back()">Voltar</a>
          {% if transaction %}
          <button type="submit" class="edit-btn">Editar</button>
          {% else %}
          <button type="submit" class="submit-btn">Cadastrar</button>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

  <!-- Modal de Categoria -->
  <div id="categoryModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeCategoryModal()">&times;</span>
      <h2>Nova Categoria</h2>
      <form method="POST" action="{{ url_for('categories.nova_categoria') }}">
        <label for="name">Nome da Categoria</label>
        <input type="text" id="name" name="name" required>

        <label for="type">Tipo</label>
        <select id="type" name="type" required>
          <option value="receita">Receita</option>
          <option value="despesa">Despesa</option>
        </select>

        <button type="submit">Criar</button>
      </form>
    </div>
  </div>

  <script>
    function openCategoryModal() {
      document.getElementById("categoryModal").style.display = "block";
    }

    function closeCategoryModal() {
      document.getElementById("categoryModal").style.display = "none";
    }

    function toggleNumberOfPayments() {
      const container = document.getElementById("number-of-payments-container");
      const checkbox = document.getElementById("checkbox");
      container.style.display = checkbox.checked ? "block" : "none";
    }

    // Set tipo visualmente
    function setTransactionType(type) {
      document.getElementById('transaction_type').value = type;
    }

    // Trocar cor do botão ativo
    function changeButtonColor(button) {
      document.getElementById('income-btn').classList.remove('active');
      document.getElementById('expense-btn').classList.remove('active');
      button.classList.add('active');
    }

    // Mostrar parcelas se checkbox já vier marcada
    window.onload = function () {
      if (document.getElementById("checkbox").checked) {
        document.getElementById("number-of-payments-container").style.display = "block";
      }
    };
  </script>
</body>

</html>
